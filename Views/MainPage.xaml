<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:helpers="clr-namespace:CozyPlayer.Helpers"
    x:Class="CozyPlayer.Views.MainPage"
    x:Name="rootPage"
    Title="{helpers:Translate Text=Title}"
    BackgroundColor="{DynamicResource BackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:BoolToPlayPauseTextConverter x:Key="BoolToPlayPauseTextConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <VerticalStackLayout Padding="12" Spacing="12">

        <!-- Header: Grid с центром и кнопкой Settings справа -->
        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center" Margin="0">
            <!-- Заголовок растягивается по всей первой колонке, центрируется -->
            <Label Text="{helpers:Translate Text=Title}"
                   FontAttributes="Bold"
                   FontSize="20"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   TextColor="{DynamicResource TextColor}" />
        </Grid>

        <!-- Add / Refresh -->
        <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
            <Button Text="{helpers:Translate Text=Button_AddFile}"
                    Clicked="OnAddFileClicked"
                    BackgroundColor="{DynamicResource PrimaryColor}"
                    TextColor="{DynamicResource SurfaceColor}"
                    CornerRadius="10" Padding="10,6" />
            <Button Text="{helpers:Translate Text=Button_Refresh}"
                    Clicked="OnRefreshClicked"
                    BackgroundColor="{DynamicResource AccentColor}"
                    TextColor="{DynamicResource SurfaceColor}"
                    CornerRadius="10" Padding="10,6" />
            <Button Grid.Column="1"
                    Text="{helpers:Translate Text=Button_Settings}"
                    Clicked="OnOpenSettingsClicked"
                    BackgroundColor="{DynamicResource AccentColor}"
                    TextColor="{DynamicResource SurfaceColor}"
                    CornerRadius="10"
                    Padding="8,6" />
        </HorizontalStackLayout>

        <!-- CollectionView треков (item template использует DynamicResource для цветов) -->
        <CollectionView ItemsSource="{Binding Tracks}" SelectionMode="None" Margin="0">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Padding="10" Margin="6" CornerRadius="10"
                           BackgroundColor="{DynamicResource SurfaceColor}"
                           HasShadow="True">
                        <Grid ColumnDefinitions="*,Auto,Auto" VerticalOptions="Center">
                            <Label Grid.Column="0"
                                   Text="{Binding Title}"
                                   VerticalOptions="Center"
                                   TextColor="{DynamicResource TextColor}" />
                            <Button Grid.Column="1" Text="▶️"
                                    Command="{Binding BindingContext.PlayCommand, Source={x:Reference rootPage}}"
                                    CommandParameter="{Binding}"
                                    BackgroundColor="Transparent"
                                    TextColor="{DynamicResource PrimaryColor}"
                                    Padding="6"/>
                            <Button Grid.Column="2" Text="🗑️"
                                    Command="{Binding BindingContext.DeleteCommand, Source={x:Reference rootPage}}"
                                    CommandParameter="{Binding}"
                                    BackgroundColor="Transparent"
                                    TextColor="DarkGray"
                                    Padding="6"/>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Now playing + Slider + Controls -->
        <Label Text="{Binding CurrentTrackTitle}"
               HorizontalOptions="Center"
               TextColor="{DynamicResource TextColor}"
               FontAttributes="Bold"/>

        <Grid ColumnDefinitions="*,Auto">
            <Slider x:Name="TrackSlider"
                    Grid.Column="0"
                    Minimum="0" Maximum="1"
                    Value="{Binding Progress, Mode=TwoWay}"
                    ValueChanged="TrackSlider_ValueChanged" />
            <StackLayout Grid.Column="1" Orientation="Vertical" HorizontalOptions="End">
                <Label Text="{Binding PositionText}" FontSize="12" HorizontalOptions="End" TextColor="{DynamicResource TextColor}"/>
                <Label Text="{Binding DurationText}" FontSize="12" HorizontalOptions="End" TextColor="{DynamicResource TextColor}"/>
            </StackLayout>
        </Grid>

        <HorizontalStackLayout HorizontalOptions="Center" Spacing="12">
            <Button Text="{Binding IsPlaying, Converter={StaticResource BoolToPlayPauseTextConverter}}"
                    Command="{Binding PlayPauseCommand}"
                    BackgroundColor="{DynamicResource PrimaryColor}"
                    TextColor="{DynamicResource SurfaceColor}"
                    CornerRadius="10" Padding="10,6" WidthRequest="140"/>
            <Label Text="{Binding KbpsText}" VerticalOptions="Center" TextColor="{DynamicResource TextColor}"/>
        </HorizontalStackLayout>

    </VerticalStackLayout>
</ContentPage>
